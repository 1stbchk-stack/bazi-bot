### 🎯 核心目標

提供準確的八字配對分析服務，協助用戶找到合適的伴侶。

### 🔑 核心功能

1. **配對功能** - 與其他用戶進行八字配對
2. **測試功能** - 任意測試兩組八字配對
3. **搜索功能** - 搜索特定年份的最佳八字組合
4. **個人分析** - 查看個人八字分析及建議
5. **解釋介紹** - 詳細解釋八字配對系統的計算依據
6. **管理員功能** - 系統管理和維護工具及測試功能
7. **清除功能** - 數據重置和清理功能

### ❌ 絕對禁止

1. **禁止跨層直接調用**
2. **禁止反向依賴**
3. **禁止循環引用**
4. **禁止硬編碼數字或文本**

## 🎯 各層職責詳解



## 🛠️ 修改指南（AI必須遵守）

### 通用原則

1. **先讀此文件**：修改前必須完整閱讀本指南
2. **向後兼容**：保持現有接口不變
3. **無版本號**：所有地方不得出現版本號標示
4. *Section Header規範*\*：所有代碼必須有完整的section header，使用數字編號（如1.1, 1.2, 2.1等）依家用1.1,小數後一位就夠, bot.py都係用小數後一位就夠
5. 文件結尾加該文件引用緊咩文件,同咩文件引用緊該文件
6. **文件結尾加目錄**: 文件結尾集合全文件所有section名稱簡介按數字編號
7. **對比原文件結尾：Section目錄**: 參考對比原文件結尾：Section目錄,以防每次修改時意外刪減
8. **文件結尾目錄後加修正紀錄**: 每次修改文件結尾目錄後加該次該文件修正內容及結合該文件之前累積修正紀錄,要說明有什麼錯,在哪錯,導致咩後果,如何改等內容
9. 所有同一文件既code要在同一code board

10\. 保持四方功能（match/testpair/findsoulmate/profile）結果一致

11\. 所有文件使用繁體中文

12\. 不得出現版本號

13\. 不得出現schema版本

14\. 代碼註釋用繁體中文

15\. 要注意github同railway免費版限制

16\. 按文件分析檢查有咩問題修正及有咩新增建議

17\. 檢查有所有文件有冇任何地方係唔align唔同標準做法

18\. 檢查有冇功能有冇code係無作用或無意義或不能用或重複



## 🚨 核心功能保護清單

### 絕對不能刪除的功能

#### 配對功能）

1. **雙方同意機制**：必須雙方都有興趣才交換聯絡方式
2. **記錄永久保存**：配對記錄訊息不會消失，可查看歷史
3. **雙向通知**：雙方都會收到配對通知
4. **每日限制**：每日最多10次配對
5. **72小時有效**：配對結果72小時內有效
6. **時間信心度**：顯示時間不確定性的影響
7. **詳細的配對分析報告**：詳細解釋分數計算方式及詳細的配對分析報告
8. **AI提示**: 結合兩組八字資料及結果連10條有關問題及AI prompt方便一鍵複製
9. **開場白及話題建議**: 根據兩組八字資料及結果提供開場白及話題建議

#### 測試功能

1. **任意測試**：可測試任意兩組八字
2. **結果一致**：與配對功能使用同一套算法
3. **時間信心度**：顯示時間不確定性的影響
4. **詳細的配對分析報告**：詳細解釋分數計算方式及詳細的配對分析報告
5. **AI提示**: 結合兩組八字資料及結果連10條有關問題及AI prompt方便一鍵複製

#### 搜索功能（soulmate\_service.py必須包含）

1. **年份限制**：只能搜索1925-2025年間的5年範圍
2. **精英篩選**：只從預先篩選的優質八字中搜索
3. **每日限制**：每日最多使用1次
4. **快速匹配**：使用貪婪算法快速找到高分配對

#### 個人功能（必須包含）

1. **八字分析**：顯示個人八字詳細分析
2. **配對建議**：建議適合的對象特徵
3. **避開建議**：建議避開的對象特徵
4. **問題解決**：提示可通過清除聊天記錄解決問題

#### 管理員功能（必須包含）

1. **統計查看**：查看用戶數、配對數等統計
2. **維護模式**：暫停bot進行維護
3. **數據清理**：清理無效或過期數據
4. **測試驗證**：使用test\_cases.py中的20組測試用例驗證系統
5. **用戶管理**：查看和管理用戶數據

### 4\. 管理員功能要求（s

* 必須包含測試驗證功能，使用test\_cases.py中的20組測試用例
* 提供系統統計數據
* 支持維護模式切換
* 支持數據清理
* 支持用戶數據管理

### 維護模式

* 管理員可暫停bot使用
* 顯示友好維護訊息
* 記錄維護期間的請求
* 必須在main\_handler.py中檢查維護狀態
* 必須在admin\_service.py中提供切換接口

### 測試用例驗證

* 每次算法修改必須通過20組測試用例驗證
* 測試用例位於config/test\_cases.py
* 管理員功能必須包含測試驗證命令
* 驗證結果必須包含通過/失敗統計



#### 清除功能（必須包含）

1. **聊天記錄清除**：用戶可清除與bot的聊天記錄
2. **數據重置**：用戶可重置自己的數據
3. **緩存清理**：清理系統緩存
4. **過期清理**：自動清理過期配對記錄

#### 通用功能（必須包含）

1. **真太陽時校正**
2. **23:00換日規則**
3. **時間信心度提示**
4. **歷史記錄查詢**
5. **AI分析功能**
6. **管理員維護功能**

## 📊 三方功能一致性保證

### 計算流程必須完全一致

match功能：用戶數據 → 配對計算 → 顯示結果
testpair功能：輸入八字 → 配對計算 → 顯示結果
findsoulmate功能：搜索條件 → 配對計算 → 顯示結果

核心計算：必須全部調用



## 🔧 具體實現要求

### 1\. 評分引擎要求（core/scoring\_engine.py）

* 所有加減分必須有註釋說明理由
* 必須按固定順序計算：

  1. 能量需求與救應
  2. 結構核心評分
  3. 人格風險評估
  4. 刑沖害壓力
  5. 神煞影響
  6. 專業化解
  7. 現實校準

* 必須輸出詳細計算步驟供解釋用

### 2\. 搜索功能要求- 使用「天命精選搜尋引擎」邏輯

* 從elite\_bazi\_seeds表中篩選
* 搜索範圍：1925-2025年，每次最多5年
* 樣本數量：最多500個優質樣本
* 停止條件：找到10個≥85分的結果或掃描完成
* 必須包含五行能量初審邏輯



### 5\. AI提示要求（utils/**init**.py）

* 不得包含用戶名
* 必須包含至少10個建議問題
* 格式統一，包含：

  * 八字資料
  * 配對分數
  * 關係模型
  * 建議問題列表
