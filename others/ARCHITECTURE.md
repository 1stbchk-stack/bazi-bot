\# 八字配對系統統一修改要求（完整整合版）

正確情況: 配對流程要求：

用戶A按/match → 收到配對通知（分數+對方基本資料，無username）+系統通知用戶B收到配對通知（分數+對方基本資料，無username）→ 同時問雙方有冇興趣

用戶A+用戶B都按"有興趣" → 雙方同時收到：對方username 




\## 🎯 核心要求

1\. \*\*絕對準確性要求\*\*：八字計算結果必須與最專業八字命理師傅國師的計算結果至少99%案例99%準確，不允許任何妥協

2\. \*\*向後兼容要求\*\*：保持所有現有接口不變，包括calculate\_bazi、calculate\_match、BaziCalculator、ScoringEngine等對外接口

3\. \*\*計算驗證要求\*\*：必須通過20個測試案例100%在指定分數範圍內驗證



\## 📁 文件結構規範

4\. \*\*Section Header規範\*\*：所有代碼必須有完整section header，使用數字編號（如1.1, 1.2, 2.1等），小數後一位

5\. \*\*文件結尾信息要求\*\*：

&nbsp;  - 該文件引用什麼文件，什麼文件引用該文件

&nbsp;  - 目錄：集合全文件所有section名稱簡介按數字編號

&nbsp;  - 修正紀錄：每次修改加該次修正內容及累積修正紀錄，說明錯誤位置、後果、修改方式

6\. \*\*文件數量限制\*\*：維持目前文件數量，不增加新文件

7\. \*\*文件對比檢查\*\*：對比原文件結尾Section目錄，防止意外刪減

\-

\## 💻 代碼規範

8\. \*\*代碼組織\*\*：所有同一文件的code要在同一code board

9\. \*\*功能一致性\*\*：保持四方功能（match/testpair/findsoulmate/profile）結果一致

10\. \*\*語言要求\*\*：所有文件使用繁體中文，代碼註釋用繁體中文

11\. \*\*版本限制\*\*：不得出現版本號，不得出現schema版本

12\. \*\*避免硬編碼\*\*：絕對不要強制校正分數或任何hardcode

13\. \*\*技術限制注意\*\*：要注意github和railway免費版限制，代碼效率要高，避免冗餘



\## 🔧 邏輯與註釋要求

14\. \*\*詳細註釋要求\*\*：每個section、函數及細節都要加註釋，說明：

&nbsp;  - 跟哪個要求

&nbsp;  - 做什麼

&nbsp;  - 為什麼這麼做

&nbsp;  - 是否固定不變

&nbsp;  - 決定分數的理由

&nbsp;  - 邏輯具體解說

&nbsp;  - 順序理由

&nbsp;  - 有否次序要求

15\. \*\*計算邏輯要求\*\*：所有加減分必須有註釋說明理由，按固定順序計算：

&nbsp;  - 能量需求與救應

&nbsp;  - 結構核心評分

&nbsp;  - 人格風險評估

&nbsp;  - 刑沖害壓力

&nbsp;  - 神煞影響

&nbsp;  - 專業化解

&nbsp;  - 現實校準



\## 🔍 檢查與修改流程

16\. \*\*先閱讀各文件\*\*：從文件尾文件信息開始，目錄開始，修正紀錄

17\. \*\*分析文件關係\*\*：分析各文件有什麼應該搬回其他文件，及有什麼應該從其他文件搬過來

18\. \*\*優化原則\*\*：以最少錯、最準確、最少行數、最少引用、最合邏輯、最優、最少文件或最少改動為目標

19\. \*\*徹底檢查\*\*：重新認真詳細檢查所有最新code是否符合要求，或有其他問題

20\. \*\*檢查項目\*\*：

&nbsp;  - 按文件分析檢查有什麼問題修正及有什麼新增建議

&nbsp;  - 檢查所有文件有沒有任何地方是不align不同標準做法

&nbsp;  - 檢查有沒有功能有沒有code是無作用、無意義、不能用或重複

&nbsp;  - 檢查引用效率，各code是否在合適文件裡面，全部文件之間關係



\## 📊 結果輸出要求

21\. \*\*個人分析顯示\*\*：基礎資訊、四柱八字、生肖、日主強弱、格局、喜用神、十神結構、夫妻分析、神煞、五行分佈

22\. \*\*配對結果顯示\*\*：兩人八字展示、配對分數、評級、描述、關係模型、計算過程摘要

23\. \*\*測試配對\*\*：固定顯示名稱（測試用戶A/B）

24\. \*\*AI提示要求\*\*：不得包含用戶名，必須包含至少10個建議問題，格式統一



\## 🚨 核心功能保護清單（絕對不能刪除）

25\. \*\*配對功能要求\*\*：

&nbsp;  - 雙方同意機制：必須雙方都有興趣才交換聯絡方式

&nbsp;  - 記錄永久保存：配對記錄訊息不會消失，可查看歷史

&nbsp;  - 雙向通知：雙方都會收到配對通知

&nbsp;  - 每日限制：每日最多10次配對

&nbsp;  - 72小時有效：配對結果72小時內有效

&nbsp;  - 時間信心度：顯示時間不確定性的影響

&nbsp;  - 詳細的配對分析報告：詳細解釋分數計算方式

26\. \*\*測試功能要求\*\*：

&nbsp;  - 任意測試：可測試任意兩組八字

&nbsp;  - 結果一致：與配對功能使用同一套算法

27\. \*\*搜索功能要求\*\*：

&nbsp;  - 年份限制：只能搜索1925-2025年間的5年範圍

&nbsp;  - 精英篩選：只從預先篩選的優質八字中搜索

&nbsp;  - 每日限制：每日最多使用1次

&nbsp;  - 快速匹配：使用貪婪算法快速找到高分配對

28\. \*\*個人功能要求\*\*：

&nbsp;  - 八字分析：顯示個人八字詳細分析

&nbsp;  - 配對建議：建議適合的對象特徵

&nbsp;  - 避開建議：建議避開的對象特徵

29\. \*\*管理員功能要求\*\*：

&nbsp;  - 統計查看：查看用戶數、配對數等統計

&nbsp;  - 維護模式：暫停bot進行維護

&nbsp;  - 數據清理：清理無效或過期數據

&nbsp;  - 測試驗證：使用test\_cases.py中的20組測試用例驗證系統

&nbsp;  - 用戶管理：查看和管理用戶數據

30\. \*\*清除功能要求\*\*：

&nbsp;  - 聊天記錄清除：用戶可清除與bot的聊天記錄

&nbsp;  - 數據重置：用戶可重置自己的數據



\## 🚫 絕對禁止

31\. \*\*禁止跨層直接調用\*\*：各層之間只能通過定義好的接口進行通信

32\. \*\*禁止反向依賴\*\*：下層模塊不應依賴上層模塊

33\. \*\*禁止循環引用\*\*：模塊之間不能形成循環依賴關係

34\. \*\*禁止硬編碼數字或文本\*\*：所有配置應來自配置系統



\## 🛠️ 修改輸出要求

35\. \*\*修改後輸出\*\*：先出修改後文件架構邏輯及在telegram中向用家不同情況下顯示什麼文字全部

36\. \*\*修改說明\*\*：說明改了什麼、怎麼符合要求、怎麼提高效率、怎麼減少code行數、新增了什麼、減少了什麼

37\. \*\*直接輸出code\*\*：修改後必須直接出修改後全文code，完全一字不漏



\## 📋 通用功能要求

38\. \*\*時間計算要求\*\*：

&nbsp;  - 真太陽時校正

&nbsp;  - 23:00換日規則

&nbsp;  - 時間信心度提示

39\. \*\*其他功能\*\*：

&nbsp;  - 歷史記錄查詢

&nbsp;  - AI分析功能

&nbsp;  - 開場白及話題建議

&nbsp;  - 管理員維護功能



\## 🔑 核心功能目標

40\. \*\*提供準確的八字配對分析服務\*\*，協助用戶找到合適的伴侶，包含：

&nbsp;  - 配對功能 - 與其他用戶進行八字配對

&nbsp;  - 測試功能 - 任意測試兩組八字配對

&nbsp;  - 搜索功能 - 搜索特定年份的最佳八字組合

&nbsp;  - 個人分析 - 查看個人八字分析及建議

&nbsp;  - 解釋介紹 - 詳細解釋八字配對系統的計算依據

&nbsp;  - 管理員功能 - 系統管理和維護工具及測試功能

&nbsp;  - 清除功能 - 數據重置和清理功能

